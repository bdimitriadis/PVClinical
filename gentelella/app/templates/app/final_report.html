{% extends "app/base_site.html" %}
{% load i18n %}
{% load staticfiles %}


{% block title %} Final Report {% endblock title %}

{% block stylesheets %}
{{ block.super }}
<link href="/static/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
<link href="/static/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    .report{
    width:793.700787px;
    border-style: solid;
    border-width: thin;
    padding: 3px;

    }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="right_col" role="main">
    <div class="row tile_count">
        <div class="col-4 col-offset-6">
            <div class="x_panel">
                <div class="x_title">
                    <h2>{% trans "My Review" %}</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                <div id="div1">
                    <p class="text-muted font-13 m-b-30">
                        {% trans "Make your own review by following next steps:" %}
                    </p>
                    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                        <li class="nav-item">
                          <button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#step1">Step 1</button>
                                <i class="fas fa-long-arrow-alt-right fa-2x"></i>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#step2" name="checkenable" id="result" disabled>Step 2</button>
                        </li>
                    </ul>
                        <div class="tab-content" id="pills-tabContent">
                        <div class="collapse" id="step1" role="tabpanel" aria-labelledby="pills-home-tab">
                            <p> You can choose which of the following  information you want to be in the overall report of this scenario.</p>
                            <p> -If you want all information from one workspace to be a part of your report, press the buttom in the left side of workspace's name.</p>
                            <p> -if you wat to choose witch information of every workspace you want to take part on your report press the buttom in the right side to see in detail what you will include. </p>
                        </div>
                        <div class="collapse" id="step2" role="tabpanel" aria-labelledby="pills-profile-tab">
                            <p>You can edit your report and include some additions that you think will be helpful to complete your review.</p>
                            <p>Click the button bellow to see your preview until now.</p>
                        </div>
                        </div>
                    <div class="container">
                            <h2>Step 1: Choose your options for every workspace</h2>
                            <br>
                            <!-- Nav tabs -->
                            <ul class="nav nav-tabs " role="tablist">
                            <li class="nav-item ">
                              <a class="nav-link active" data-toggle="tab" href="#OHDSI">OHDSI</a>
                            </li>
                            <li class="nav-item">
                              <a class="nav-link" data-toggle="tab" href="#OpenFDA">OpenFDA</a>
                            </li>
                            <li class="nav-item">
                              <a class="nav-link" data-toggle="tab" href="#PubMed">PubMed</a>
                            </li>
                            </ul>
                            <!-- Tab panes -->
                            <div class="tab-content">
                            <div id="OHDSI" class="container tab-pane active"><br>
                                <br>
                                <div class="container">
                                    <div class="panel-group" id="accordion">
                                        <div class="panel panel-default">
                                          <div class="panel-heading">
                                            <h4 class="panel-title">
                                              <a data-toggle="collapse" data-parent="#accordion" href="#collapseohdsi" style="color:#5A738E;">Choose which of the OHDSI views information you want to include</a>
                                            </h4>

                                          </div>
                                          <div id="collapseohdsi" class="panel-collapse collapse in">
                                              <br>
                                              <table class="table table-striped table-bordered" style="width:500px">
                                                <tr>
                                                    {% if ir_id %}
                                                        <td><button id="IrOHDSIBtn" data-target="#irModal" class="btn btn-secondary" data-toggle="modal" data-irid="{{ ir_id }}" data-scenario="{{ scenario_open }}">
                                                        <i class="fas fa-search-plus"></i></button> &nbsp Incidence Rate</td>
                                                    {% else %}
                                                        <td><button data-target="#noneModal" class="btn btn-secondary" data-toggle="modal">
                                                        <i class="fas fa-search-plus"></i></button> &nbsp Incidence Rate</td>
                                                    {% endif %}
                                                    <td>
                                                        <button class="btn btn-secondary" id="IrNotes" data-toggle="modal" data-target="#ohdsi_ir_notes" data-note="{{ ir_notes }}">
                                                            <i class="fas fa-search-plus"></i>
                                                        </button>&nbsp; Notes
                                                    </td>
                                                </tr>
                                                <tr>
                                                    {% if char_id %}
                                                <td><button id="CharOHDSIBtn" data-target="#charModal" class="btn btn-secondary" data-toggle="modal" data-charid="{{ char_id }}" data-scenario="{{ scenario_open }}">
                                                <i class="fas fa-search-plus"></i></button>&nbsp; Cohort Characterization</td>
                                                    {% else %}
                                                        <td><button data-target="#noneModal" class="btn btn-secondary" data-toggle="modal">
                                                        <i class="fas fa-search-plus"></i></button> &nbsp; Cohort Characterization</td>
                                                    {% endif %}
                                                    <td>
                                                        <button class="btn btn-secondary" id="CharNotes" data-toggle="modal" data-target="#ohdsi_char_notes" data-note="{{ char_notes }}">
                                                            <i class="fas fa-search-plus"></i>
                                                        </button>&nbsp; Notes
                                                    </td>
                                                </tr>
                                                <tr>
                                                  {% if cp_id %}
                                                    <td><button id="PathOHDSIBtn" data-target="#pathModal" class="btn btn-secondary" data-toggle="modal" data-pathid="{{ cp_id }}" data-scenario="{{ scenario_open }}">
                                                    <i class="fas fa-search-plus"></i></button>&nbsp;  Cohort Pathways</td>
                                                  {% else %}
                                                    <td><button data-target="#noneModal" class="btn btn-secondary" data-toggle="modal">
                                                    <i class="fas fa-search-plus"></i></button> &nbsp; Cohort Pathways</td>
                                                  {% endif %}
                                                  <td>
                                                     <button class="btn btn-secondary" id="PathwaysNotes" data-toggle="modal" data-target="#ohdsi_pathways_notes" data-note="{{ pathways_notes }}">
                                                        <i class="fas fa-search-plus"></i>
                                                    </button>&nbsp; Notes
                                                  </td>
                                                </tr>
                                                </table>
                                              <br>
                                          </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="OpenFDA" class="container tab-pane fade"><br>
                                <div style="padding-left:30px;">
                             <input type="checkbox" id="opendfa"> <label for="openfda">&nbsp<i> If you want to include something from OpenFDA in your
                                  report, check the checkbox in the right side and open the folder button in every case
                                  to select which information you want from this workspace in your final report.</i></label></div>
                                <br>
                                <div class="container">
                                    <div class="panel-group" id="combsAccordion">

                                        {% for d,c,k in drug_condition_hash %}

                                <div id="{{ d }}{% if d and c %} - {% endif %}{{ c }}" class="panel panel-default">
                                    <div class="panel-heading">
                                      <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#combsAccordion" href="#collapse{{ forloop.counter }}" style="color:#5A738E;">{{ d }}{% if d and c %} - {% endif %}{{ c }}</a>
                                      </h4>
                                    </div>
                                    <div id="collapse{{ forloop.counter }}" class="panel-collapse collapse {% if forloop.counter == 1 %}in{% endif %}">
                                      <div class="panel-body">

                                          <strong style="padding-right:80px"><button id="QuickViewDrugEventShinyBtn{{ forloop.counter }}"  data-target="#shinyModal" class="btn btn-secondary" data-toggle="modal"  data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Quick View &nbsp</strong>

                                          {% if d and c %}

                                         <strong style="padding-right:80px"><button id="DynPRRShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-toggle="modal" data-target="#shinyModal" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button> Dynamic PRR</strong>

                                         <strong style="padding-right:80px"><button id="ChangePointShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-toggle="modal" data-target="#shinyModal" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Change Points Analysis</strong>

                                          {% elif d %}

                                         <strong style="padding-right:80px"><button id="DashShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-target="#shinyModal" data-toggle="modal"  data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Dashboard &nbsp &nbsp</strong>

                                         <strong style="padding-right:80px"><button id="RR_DShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-target="#shinyModal" data-toggle="modal" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Reporting Rates &nbsp &nbsp</strong>

                                         <strong style="padding-right:80px"><button  id="LrTestShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-target="#shinyModal" data-toggle="modal" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Likelihood Rate Test &nbsp &nbsp</strong>

                                          {% elif c %}
                                          <strong style="padding-right:80px"><button id="RR_EShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-target="#shinyModal" data-toggle="modal" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Reporting Rates &nbsp &nbsp</strong>
                                          <strong style="padding-right:80px"><button  id="LrTest_EShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-target="#shinyModal" data-toggle="modal" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Likelihood Rate Test &nbsp &nbsp</strong>
                                          {%endif%}
<!--                                          <strong style="padding-right:80px"><button id="ReportViewShinyBtn{{ forloop.counter }}" class="btn btn-secondary" data-toggle="modal" data-target="#shinyModal" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}"><i class="fas fa-search-plus"></i></button>Report View</strong>-->

                                          {%for key1,value1 in notes_openfda1.items%}
                                          {% if key1 == k %}
                                           <strong style="padding-right:80px"><button class="btn btn-secondary" id="NotesBtn{{ k }}" data-toggle="modal" data-target="#shinyModal_notes" data-note="{{value1|striptags|safe}}" data-drug="{{d}}" data-con="{{c}}" data-hash="{{k}}" ><i class="fas fa-search-plus"></i></button>Notes</strong>

                                          {% endif %}
                                          {%endfor%}

                                      </div>
                                    </div>

                                </div>
                                        {% endfor %}

                                    </div>
                                </div>
                            </div>
                            <div id="PubMed" class="container tab-pane fade"><br>
                                <input type="checkbox" id="allPubMed">
                              <label for="pubmed"> Add every information that I had from PubMed</label>
                                <br></br>
                                <div class="container">
                                    <div class="panel-group" id="accordionpub">
                                        <div class="panel panel-default">
                                          <div class="panel-heading">
                                            <h4 class="panel-title">
                                              <a data-toggle="collapse" data-parent="#accordion" href="#collapsepub" style="color:#5A738E;">Choose which of the PubMed views information you want to include</a>
                                            </h4>
                                          </div>
                                          <div id="collapsepub" class="panel-collapse collapse in">
                                              <br>
                                              <table class="table table-striped table-bordered" style="width:800px">
                                                <tr>
                                                <td><input type="checkbox"  value="yes">  &nbsp  Different elemental infant formulas show equivalent phosphorus and calcium bioavailability in healthy volunteers.</td>
                                                <td><input type="checkbox"  value="yes">&nbsp Notes</td>
                                                </tr>
                                                <tr>
                                                <td><input type="checkbox"  value="yes">&nbsp  Low-dose PPI to prevent bleeding after ESD: A multicenter randomized controlled study.</td>
                                                <td><input type="checkbox"  value="yes">&nbsp Notes</td>
                                                </tr>

                                                </table>
                                              <br>
                                          </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            </div>
                            </div>
                    <button type="button" class="btn btn-primary active" name="checkenable" id="result1"  disabled>
                    <i class="fas fa-spinner"></i> &nbsp Proceed to step 2 to see the review's status until now</button></a>
                </div>

                <div id="div2">
                    <p class="text-muted font-13 m-b-30">
                        {% trans "Make your own review by following next steps:" %}
                    </p>
                    <ul class="nav nav-pills mb-3" id="pills-tab1" role="tablist">
                        <li class="nav-item">
                          <button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#step11" id="link1">Step 1</button>
                                <i class="fas fa-long-arrow-alt-left fa-2x"></i>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="btn btn-secondary" data-toggle="collapse" data-target="#step21" name="checkenable" >Step 2</button>
                        </li>
                    </ul>
                        <div class="tab-content" id="pills-tabContent1">
                        <div class="collapse" id="step11" role="tabpanel" aria-labelledby="pills-home-tab">
                           <p></p>
                        </div>
                        <div class="collapse" id="step21" role="tabpanel" aria-labelledby="pills-profile-tab">
                            <p>Now you can edit your report and include some additions that you think will be helpfull to complete your review.</p>
                            <p>Click in frames bellow to write your comments and save some extra text in your final report.</p>
                        </div>
                        </div>
                     <div class="container">
                         <h2>Step 2: Edit and fill in your review with the last additions.</h2>
                        <div class="x_panel">
                            <div class="report">

                            <div style="color:black" id="report_preview" ></div>
                            </div>
                        </div>
                     </div>
                    <br>
                    <button type="button" class="btn btn-primary active" id="download">
                    <i class="fas fa-spinner"></i> &nbsp Download your final report</button>

                </div>
            </div>

{% include 'app/modals/shiny_modal.html'%}

        </div>

</div>

</div>

{% endblock content %}


{% block javascripts %}

    {{ block.super }}
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>-->
    <script src="/static/build/js/final_report.js"></script>

    <script>
    $(document).ready(function(){
        var all_notes={"empty":"empty"};
        var note ;
        var hash ;
        var ir_table_rep=0 ;
        var ir_all_rep=0 ;
        var pre_table_rep=0 ;
        var pre_chart_rep=0 ;
        var drug_table_rep=0 ;
        var drug_chart_rep=0 ;
        var demograph_table_rep=0;
        var demograph_chart_rep=0 ;
        var charlson_table_rep=0 ;
        var charlson_chart_rep=0 ;
        var gen_table_rep=0 ;
        var gen_chart_rep=0 ;
        var cp_all_rep=0 ;


        $("#irnote").on("change", function(){

            if($(this).is(':checked')){
                all_notes['ir']="{{ ir_notes|striptags|safe }}";
            };

        });

        $("#charnote").on("change", function(){

            if($(this).is(':checked')){
                all_notes['char']="{{ char_notes|striptags|safe }}";
            };

        });

        $("#pathwaysnote").on("change", function(){

            if($(this).is(':checked')){
                all_notes['pathways']="{{ pathways_notes|striptags|safe }}";
            };

        });

        $("#ir_table").on("change", function(){

            if ($(this).is(':checked')) {
                ir_table_rep = 1 ;

            }else{
                ir_table_rep = 0 ;

            }

        });
        $("#ir_all").on("change", function(){

            if ($(this).is(':checked')) {
                ir_all_rep = 1 ;

            }else{
                ir_all_rep = 0 ;

            }

        });

        $("#pre_table").on("change", function(){

            if ($(this).is(':checked')) {
                pre_table_rep = 1 ;

            }else{
                pre_table_rep = 0 ;

            }

        });
        $("#pre_chart").on("change", function(){

            if ($(this).is(':checked')) {
                pre_chart_rep = 1 ;

            }else{
                pre_chart_rep = 0 ;

            }
        });

        $("#drug_table").on("change", function(){

            if ($(this).is(':checked')) {
                drug_table_rep = 1 ;

            }else{
                drug_table_rep = 0 ;

            }
        });

        $("#drug_chart").on("change", function(){

            if ($(this).is(':checked')) {
                drug_chart_rep = 1 ;


            }else{
                drug_chart_rep = 0 ;

            }

        });

        $("#demograph_table").on("change", function(){

            if ($(this).is(':checked')) {
                demograph_table_rep = 1 ;

            }else{
                demograph_table_rep = 0 ;

            }
        });

        $("#demograph_chart").on("change", function(){

            if ($(this).is(':checked')) {
                demograph_chart_rep = 1 ;


            }else{
                demograph_chart_rep = 0 ;

            }
        });

        $("#charlson_table").on("change", function(){

            if ($(this).is(':checked')) {
                charlson_table_rep = 1 ;

            }else{
                charlson_table_rep = 0 ;

            }
        });

        $("#charlson_chart").on("change", function(){

            if ($(this).is(':checked')) {
                charlson_chart_rep = 1 ;


            }else{
                charlson_chart_rep = 0 ;

            }
        });

        $("#gen_table").on("change", function(){

            if ($(this).is(':checked')) {
                gen_table_rep = 1 ;

            }else{
                gen_table_rep = 0 ;

            }
        });

        $("#gen_chart").on("change", function(){

            if ($(this).is(':checked')) {
                gen_chart_rep = 1 ;


            }else{
                gen_chart_rep = 0 ;

            }
        });

        $("#cp_all").on("change", function(){

            if ($(this).is(':checked')) {
                cp_all_rep = 1 ;

            }else{
                cp_all_rep = 0 ;

            }
        });

        $("#IrOHDSIBtn").click(function(){

          var scenario= $(this).data('scenario');
          var ir_id= $(this).data('irid');
          var src_ir= "http://127.0.0.1:8000/ir/" + scenario+ "/" + ir_id ;

            document.getElementById('Ir_frame').src = src_ir;
        });

        $("#CharOHDSIBtn").click(function(){

          var scenario= $(this).data('scenario');
          var char_id= $(this).data('charid');
          var src_char= "http://127.0.0.1:8000/char/" + scenario+ "/" + char_id ;

            document.getElementById('Char_frame').src = src_char;
        });

        $("#PathOHDSIBtn").click(function(){

          var scenario= $(this).data('scenario');
          var path_id= $(this).data('pathid');
          var src_path= "http://127.0.0.1:8000/cp/" + scenario+ "/" + path_id ;

            document.getElementById('Path_frame').src = src_path;
        });

    $("#result1").click(function() {
        var scid={{scenario_open}};
        var note_val="";


        $.ajax({
                url: "/ajax/report_pdf",
                data: {"scenario_id": scid , "cp_all_rep": cp_all_rep, "charlson_table_rep": charlson_table_rep,
                "gen_table_rep":gen_table_rep, "gen_chart_rep":gen_chart_rep,
                "charlson_chart_rep":charlson_chart_rep, "demograph_table_rep": demograph_table_rep,
                "demograph_chart_rep":demograph_chart_rep,"drug_table_rep":drug_table_rep,
                "drug_chart_rep":drug_chart_rep,"pre_table_rep": pre_table_rep,"pre_chart_rep": pre_chart_rep,
                "ir_table_rep": ir_table_rep,"ir_all_rep": ir_all_rep,"all_notes": JSON.stringify(all_notes)},
                dataType: "html",
                success: function (res) {
                        $('#report_preview').html(res);

                  },
                  error: function (res) {
                    console.log("error "+res);
                }
            });

        $("#div2").show();
        $("#div1").hide();
    });

        $("#download").click(function() {
            var scid={{scenario_open}};

            var extra_notes=$("#editFnote").val();

        $.ajax({
                url: "/ajax/print_report",
                data: {"scenario_id": scid , "all_notes": JSON.stringify(all_notes), "extra_notes": JSON.stringify(extra_notes)},
                dataType: "html",
                success: function (res) {

                  },
                  error: function (res) {
                    console.log("error "+res);
                }
            });
    });
    });
    </script>

{% endblock javascripts%}